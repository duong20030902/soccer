@using Soccer.Font_end.Areas.ViewModels
@model PaginatedBookingResponse
@{
    ViewData["Title"] = "Quản lý Booking";
    var totalBookings = Model.Data.Count();
    var confirmedBookings = Model.Data.Count(b => b.Status == "Confirmed");
    var pendingBookings = Model.Data.Count(b => b.Status == "Pending");
    var cancelledBookings = Model.Data.Count(b => b.Status == "Cancelled");
    var completedBookings = Model.Data.Count(b => b.Status == "Completed");
    var totalRevenue = Model.Data.Where(b => b.Status == "Confirmed" || b.Status == "Completed").Sum(b => b.Price);
    var totalCommission = Model.Data.Where(b => b.Status == "Confirmed" || b.Status == "Completed").Sum(b => b.Commission);
}

<div class="section-body mt-3">
    <div class="container-fluid">
        <!-- Header Section -->
        <div class="row clearfix">
            <div class="col-lg-12">
                <div class="mb-4 d-flex justify-content-between align-items-center">
                    <div>
                        <h4>Quản lý Booking Sân Bóng</h4>
                        <small>Theo dõi và quản lý tất cả các đặt sân. <a href="#" id="refreshData">Làm mới dữ liệu</a></small>
                    </div>
                    <div class="card-options">
                        <a href="@Url.Action("Create")" class="btn btn-primary">
                            <i class="fa fa-plus"></i> Tạo booking mới
                        </a>
                        <a href="@Url.Action("Statistics")" class="btn btn-info">
                            <i class="fa fa-bar-chart"></i> Thống kê
                        </a>
                        <a href="@Url.Action("Calendar")" class="btn btn-success">
                            <i class="fa fa-calendar"></i> Xem lịch
                        </a>
                        <div class="btn-group ml-2" role="group">
                            <button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown">
                                <i class="fa fa-ellipsis-h"></i> Khác
                            </button>
                            <div class="dropdown-menu">
                                <a class="dropdown-item" href="#">
                                    <i class="fa fa-download"></i> Xuất Excel
                                </a>
                                <a class="dropdown-item" href="#">
                                    <i class="fa fa-upload"></i> Nhập dữ liệu
                                </a>
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item" href="#" onclick="bulkActions()">
                                    <i class="fa fa-edit"></i> Thao tác hàng loạt
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row clearfix row-deck">
            <div class="col-xl-2 col-lg-4 col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Tổng Booking</h3>
                    </div>
                    <div class="card-body">
                        <h5 class="number mb-0 font-32 counter">@totalBookings</h5>
                        <span class="font-12">Tất cả đặt sân... <a href="@Url.Action("Index")">Chi tiết</a></span>
                    </div>
                </div>
            </div>
            <div class="col-xl-2 col-lg-4 col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Đã Xác Nhận</h3>
                    </div>
                    <div class="card-body">
                        <h5 class="number mb-0 font-32 counter text-success">@confirmedBookings</h5>
                        <span class="font-12">Booking đã xác nhận... <a href="@Url.Action("Index", new { status = "Confirmed" })">Chi tiết</a></span>
                    </div>
                </div>
            </div>
            <div class="col-xl-2 col-lg-4 col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Chờ Xử Lý</h3>
                    </div>
                    <div class="card-body">
                        <h5 class="number mb-0 font-32 counter text-warning">@pendingBookings</h5>
                        <span class="font-12">Booking chờ xử lý... <a href="@Url.Action("Index", new { status = "Pending" })">Chi tiết</a></span>
                    </div>
                </div>
            </div>
            <div class="col-xl-2 col-lg-4 col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Đã Hủy</h3>
                    </div>
                    <div class="card-body">
                        <h5 class="number mb-0 font-32 counter text-danger">@cancelledBookings</h5>
                        <span class="font-12">Booking đã hủy... <a href="@Url.Action("Index", new { status = "Cancelled" })">Chi tiết</a></span>
                    </div>
                </div>
            </div>
            <div class="col-xl-2 col-lg-4 col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Hoàn Thành</h3>
                    </div>
                    <div class="card-body">
                        <h5 class="number mb-0 font-32 counter text-info">@completedBookings</h5>
                        <span class="font-12">Booking hoàn thành... <a href="@Url.Action("Index", new { status = "Completed" })">Chi tiết</a></span>
                    </div>
                </div>
            </div>
            <div class="col-xl-2 col-lg-4 col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Doanh Thu</h3>
                    </div>
                    <div class="card-body">
                        <h5 class="number mb-0 font-32 counter text-primary">@totalRevenue.ToString("N0")</h5>
                        <span class="font-12">VNĐ tổng doanh thu... <a href="@Url.Action("Statistics")">Chi tiết</a></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row clearfix row-deck">
            <!-- Filter and Booking List -->
            <div class="col-xl-12 col-lg-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Danh Sách Booking</h3>
                        <div class="card-options">
                            <button class="btn btn-sm btn-primary mr-1" onclick="filterByStatus('all')">Tất cả</button>
                            <button class="btn btn-sm btn-success mr-1" onclick="filterByStatus('Confirmed')">Đã xác nhận</button>
                            <button class="btn btn-sm btn-warning mr-1" onclick="filterByStatus('Pending')">Chờ xử lý</button>
                            <button class="btn btn-sm btn-danger mr-1" onclick="filterByStatus('Cancelled')">Đã hủy</button>
                            <button class="btn btn-sm btn-info" onclick="filterByStatus('Completed')">Hoàn thành</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Filter Form -->
                        <div class="d-sm-flex justify-content-between mb-3">
                            <form method="get" class="d-flex align-items-center">
                                <div class="me-3 mr-3">
                                    <select class="form-control" name="status" style="min-width: 150px;">
                                        <option value="">Tất cả trạng thái</option>
                                        @foreach (var statusOption in ViewBag.StatusList as List<string>)
                                        {
                                            @if (ViewBag.CurrentStatus == statusOption)
                                            {
                                                <option value="@statusOption" selected>@statusOption</option>
                                            }
                                            else
                                            {
                                                <option value="@statusOption">@statusOption</option>
                                            }
                                        }
                                    </select>
                                </div>
                                <div class="me-3 mr-3">
                                    <input type="text" class="form-control form-control-sm" name="fieldName"
                                           value="@ViewBag.CurrentFieldName" placeholder="Tên sân..." style="min-width: 150px;">
                                </div>
                                <div class="me-3 mr-3">
                                    <input type="text" class="form-control form-control-sm" name="userName"
                                           value="@ViewBag.CurrentUserName" placeholder="Khách hàng..." style="min-width: 150px;">
                                </div>
                                <div>
                                    <button type="submit" class="btn btn-sm btn-primary me-2 mr-2">Lọc</button>
                                    <a href="@Url.Action("Index")" class="btn btn-sm btn-secondary">Reset</a>
                                </div>
                            </form>
                        </div>

                        <!-- Success/Error Messages -->
                        @if (TempData["SuccessMessage"] != null)
                        {
                            <div class="alert alert-success alert-dismissible fade show" role="alert">
                                @TempData["SuccessMessage"]
                                <button type="button" class="close" data-dismiss="alert">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                        }

                        @if (TempData["ErrorMessage"] != null)
                        {
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                @TempData["ErrorMessage"]
                                <button type="button" class="close" data-dismiss="alert">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                        }

                        <!-- Bookings Table -->
                        @if (Model.Data.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-hover table-striped text-nowrap table-vcenter mb-0">
                                    <thead>
                                        <tr>
                                            <th>
                                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                            </th>
                                            <th>#</th>
                                            <th>Sân Bóng</th>
                                            <th>Khách Hàng</th>
                                            <th>Ngày & Giờ</th>
                                            <th>Giá Tiền</th>
                                            <th>Hoa Hồng</th>
                                            <th>Trạng Thái</th>
                                            <th>Thao Tác</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var booking in Model.Data)
                                        {
                                            <tr>
                                                <td>
                                                    <input type="checkbox" class="booking-checkbox" value="@booking.BookingId">
                                                </td>
                                                <td>#@booking.BookingId</td>
                                                <td>
                                                    <strong>@booking.FieldName</strong>
                                                </td>
                                                <td>@booking.UserName</td>
                                                <td>
                                                    <div>@booking.Date.ToString("dd/MM/yyyy")</div>
                                                    <small class="text-muted">@booking.StartTime.ToString("HH:mm") - @booking.EndTime.ToString("HH:mm")</small>
                                                </td>
                                                <td>
                                                    <strong class="text-success">@booking.Price.ToString("N0") VNĐ</strong>
                                                </td>
                                                <td>
                                                    <span class="text-info">@booking.Commission.ToString("N0") VNĐ</span>
                                                </td>
                                                <td>
                                                    @switch (booking.Status)
                                                    {
                                                        case "Confirmed":
                                                            <span class="tag tag-success">Đã xác nhận</span>
                                                            break;
                                                        case "Pending":
                                                            <span class="tag tag-warning">Chờ xử lý</span>
                                                            break;
                                                        case "Cancelled":
                                                            <span class="tag tag-danger">Đã hủy</span>
                                                            break;
                                                        case "Completed":
                                                            <span class="tag tag-info">Hoàn thành</span>
                                                            break;
                                                        default:
                                                            <span class="tag tag-secondary">@booking.Status</span>
                                                            break;
                                                    }
                                                </td>
                                                <td>
                                                    <div class="item-action dropdown">
                                                        <a href="javascript:void(0)" data-toggle="dropdown" aria-expanded="false">
                                                            <i class="fa fa-ellipsis-v"></i>
                                                        </a>
                                                        <div class="dropdown-menu dropdown-menu-right">
                                                            <a href="@Url.Action("Details", new { id = booking.BookingId })" class="dropdown-item">
                                                                <i class="dropdown-icon fa fa-eye"></i> Xem chi tiết
                                                            </a>
                                                            <a href="@Url.Action("Edit", new { id = booking.BookingId })" class="dropdown-item">
                                                                <i class="dropdown-icon fa fa-edit"></i> Chỉnh sửa
                                                            </a>
                                                            <div class="dropdown-divider"></div>
                                                            @if (booking.Status == "Pending")
                                                            {
                                                                <a href="javascript:void(0)" class="dropdown-item" onclick="updateStatus(@booking.BookingId, 'Confirmed')">
                                                                    <i class="dropdown-icon fa fa-check text-success"></i> Xác nhận
                                                                </a>
                                                            }
                                                            @if (booking.Status == "Confirmed")
                                                            {
                                                                <a href="javascript:void(0)" class="dropdown-item" onclick="updateStatus(@booking.BookingId, 'Completed')">
                                                                    <i class="dropdown-icon fa fa-check-circle text-info"></i> Hoàn thành
                                                                </a>
                                                            }
                                                            @if (booking.Status != "Cancelled" && booking.Status != "Completed")
                                                            {
                                                                <a href="javascript:void(0)" class="dropdown-item text-danger" onclick="cancelBooking(@booking.BookingId)">
                                                                    <i class="dropdown-icon fa fa-times"></i> Hủy booking
                                                                </a>
                                                            }
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>

                            <!-- Bulk Actions -->
                            <div class="mt-3" id="bulkActionsPanel" style="display: none;">
                                <div class="card">
                                    <div class="card-body">
                                        <h6>Thao tác với các booking đã chọn:</h6>
                                        <div>
                                            <button class="btn btn-sm btn-success me-2 mr-2" onclick="bulkUpdateStatus('Confirmed')">
                                                <i class="fa fa-check"></i> Xác nhận tất cả
                                            </button>
                                            <button class="btn btn-sm btn-info me-2 mr-2" onclick="bulkUpdateStatus('Completed')">
                                                <i class="fa fa-check-circle"></i> Hoàn thành tất cả
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="bulkUpdateStatus('Cancelled')">
                                                <i class="fa fa-times"></i> Hủy tất cả
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Pagination -->
                            @if (Model.Pagination.TotalPages > 1)
                            {
                                <div class="d-flex justify-content-between align-items-center mt-4">
                                    <div>
                                        <small class="text-muted">
                                            Hiển thị @((Model.Pagination.Page - 1) * Model.Pagination.PageSize + 1) -
                                            @Math.Min(Model.Pagination.Page * Model.Pagination.PageSize, Model.Pagination.TotalCount)
                                            trong tổng số @Model.Pagination.TotalCount booking
                                        </small>
                                    </div>
                                    <nav>
                                        <ul class="pagination pagination-sm">
                                            <!-- Previous -->
                                            @if (Model.Pagination.Page > 1)
                                            {
                                                <li class="page-item">
                                                    <a class="page-link" href="@Url.Action("Index", new {
                                                        page = Model.Pagination.Page - 1,
                                                        pageSize = Model.Pagination.PageSize,
                                                        status = ViewBag.CurrentStatus,
                                                        fieldName = ViewBag.CurrentFieldName,
                                                        userName = ViewBag.CurrentUserName
                                                    })">Trước</a>
                                                </li>
                                            }

                                            <!-- Page Numbers -->
                                            @{
                                                var startPage = Math.Max(1, Model.Pagination.Page - 2);
                                                var endPage = Math.Min(Model.Pagination.TotalPages, Model.Pagination.Page + 2);
                                            }

                                            @for (int i = startPage; i <= endPage; i++)
                                            {
                                                <li class="page-item @(i == Model.Pagination.Page ? "active" : "")">
                                                    <a class="page-link" href="@Url.Action("Index", new {
                                                        page = i,
                                                        pageSize = Model.Pagination.PageSize,
                                                        status = ViewBag.CurrentStatus,
                                                        fieldName = ViewBag.CurrentFieldName,
                                                        userName = ViewBag.CurrentUserName
                                                    })">@i</a>
                                                </li>
                                            }

                                            <!-- Next -->
                                            @if (Model.Pagination.Page < Model.Pagination.TotalPages)
                                            {
                                                <li class="page-item">
                                                    <a class="page-link" href="@Url.Action("Index", new {
                                                        page = Model.Pagination.Page + 1,
                                                        pageSize = Model.Pagination.PageSize,
                                                        status = ViewBag.CurrentStatus,
                                                        fieldName = ViewBag.CurrentFieldName,
                                                        userName = ViewBag.CurrentUserName
                                                    })">Sau</a>
                                                </li>
                                            }
                                        </ul>
                                    </nav>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="text-center py-5">
                                <i class="fa fa-calendar" style="font-size: 3rem; color: #ccc;"></i>
                                <h5 class="mt-3 text-muted">Không có booking nào</h5>
                                <p class="text-muted">Chưa có booking nào phù hợp với bộ lọc hiện tại.</p>
                                <a href="@Url.Action("Create")" class="btn btn-primary">
                                    <i class="fa fa-plus"></i> Tạo booking đầu tiên
                                </a>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Revenue Summary và Status Distribution giữ nguyên như code cũ -->
        <div class="row clearfix">
            <div class="col-xl-4 col-lg-12 col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Tóm Tắt Doanh Thu</h3>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-4 border-right pb-4 pt-4">
                                <label class="mb-0 font-13">Tổng Doanh Thu</label>
                                <h4 class="font-30 font-weight-bold text-col-blue">@totalRevenue.ToString("N0")</h4>
                                <small class="text-muted">VNĐ</small>
                            </div>
                            <div class="col-4 border-right pb-4 pt-4">
                                <label class="mb-0 font-13">Hoa Hồng</label>
                                <h4 class="font-30 font-weight-bold text-col-blue">@totalCommission.ToString("N0")</h4>
                                <small class="text-muted">VNĐ</small>
                            </div>
                            <div class="col-4 pb-4 pt-4">
                                <label class="mb-0 font-13">Lợi Nhuận</label>
                                <h4 class="font-30 font-weight-bold text-col-blue">@((totalRevenue - totalCommission).ToString("N0"))</h4>
                                <small class="text-muted">VNĐ</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Distribution -->
            <div class="col-xl-4 col-lg-6 col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Phân Bổ Trạng Thái</h3>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-vcenter mb-0">
                            <tbody>
                                <tr>
                                    <td class="tx-medium">
                                        <i class="fa fa-circle text-success"></i> Đã xác nhận
                                    </td>
                                    <td class="text-right">@confirmedBookings</td>
                                    <td class="text-right">@(totalBookings > 0 ? (confirmedBookings * 100 / totalBookings).ToString("F1") : "0")%</td>
                                </tr>
                                <tr>
                                    <td class="tx-medium">
                                        <i class="fa fa-circle text-warning"></i> Chờ xử lý
                                    </td>
                                    <td class="text-right">@pendingBookings</td>
                                    <td class="text-right">@(totalBookings > 0 ? (pendingBookings * 100 / totalBookings).ToString("F1") : "0")%</td>
                                </tr>
                                <tr>
                                    <td class="tx-medium">
                                        <i class="fa fa-circle text-info"></i> Hoàn thành
                                    </td>
                                    <td class="text-right">@completedBookings</td>
                                    <td class="text-right">@(totalBookings > 0 ? (completedBookings * 100 / totalBookings).ToString("F1") : "0")%</td>
                                </tr>
                                <tr>
                                    <td class="tx-medium">
                                        <i class="fa fa-circle text-danger"></i> Đã hủy
                                    </td>
                                    <td class="text-right">@cancelledBookings</td>
                                    <td class="text-right">@(totalBookings > 0 ? (cancelledBookings * 100 / totalBookings).ToString("F1") : "0")%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Recent Activities -->
            <div class="col-xl-4 col-lg-6 col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Hoạt Động Gần Đây</h3>
                    </div>
                    <div class="card-body">
                        @{
                            var recentBookings = Model.Data.OrderByDescending(b => b.BookingTime).Take(5);
                        }
                        @foreach (var booking in recentBookings)
                        {
                            <div class="d-flex align-items-center mb-3">
                                <div class="flex-shrink-0">
                                    @switch (booking.Status)
                                    {
                                        case "Confirmed":
                                            <i class="fa fa-check-circle text-success fa-lg"></i>
                                            break;
                                        case "Pending":
                                            <i class="fa fa-clock-o text-warning fa-lg"></i>
                                            break;
                                        case "Cancelled":
                                            <i class="fa fa-times-circle text-danger fa-lg"></i>
                                            break;
                                        case "Completed":
                                            <i class="fa fa-check-circle text-info fa-lg"></i>
                                            break;
                                        default:
                                            <i class="fa fa-circle text-secondary fa-lg"></i>
                                            break;
                                    }
                                </div>
                                <div class="flex-grow-1 ml-3">
                                    <div class="font-weight-bold">@booking.UserName</div>
                                    <div class="text-muted small">
                                        Đặt @booking.FieldName - @booking.Date.ToString("dd/MM/yyyy")
                                    </div>
                                    <div class="text-muted small">
                                        @booking.BookingTime.ToString("dd/MM/yyyy HH:mm")
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .booking-checkbox {
        transform: scale(1.2);
    }

    .bulk-actions-panel {
        background-color: #f8f9fa;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-top: 1rem;
    }

    .btn + .btn-group {
        margin-left: 0.5rem;
    }

    .btn-group .btn + .btn {
        margin-left: 0;
    }

    .card-options .btn {
        margin-right: 0.5rem;
    }

        .card-options .btn:last-child,
        .card-options .btn-group:last-child {
            margin-right: 0;
        }

    .counter {
        font-weight: bold;
        color: #007bff;
    }

    .card-circle {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .l-bg-cyan {
        background: linear-gradient(87deg, #17a2b8, #17a2b8) !important;
    }

    .l-bg-green {
        background: linear-gradient(87deg, #28a745, #28a745) !important;
    }

    .l-bg-orange {
        background: linear-gradient(87deg, #fd7e14, #fd7e14) !important;
    }

    .l-bg-blue {
        background: linear-gradient(87deg, #007bff, #007bff) !important;
    }

    .spinner-border {
        width: 3rem;
        height: 3rem;
    }
</style>

@section Scripts {
    <script>
        // Đảm bảo jQuery được load
        if (typeof jQuery === 'undefined') {
            console.error('jQuery is not loaded!');
        }

        $(document).ready(function() {
            // Khởi tạo các component
            initializeComponents();
        });

        function initializeComponents() {
            // Counter animation
            if (typeof $.fn.countTo !== 'undefined') {
                $('.counter').countTo();
            }

            // Tooltip
            if (typeof $.fn.tooltip !== 'undefined') {
                $('[data-toggle="tooltip"]').tooltip();
            }

            // Auto refresh every 5 minutes
            setInterval(function() {
                if (confirm('Dữ liệu sẽ được làm mới. Bạn có muốn tiếp tục?')) {
                    location.reload();
                }
            }, 5 * 60 * 1000);
        }

        // AJAX Functions với error handling
        function updateStatus(bookingId, status) {
            if (confirm('Bạn có chắc chắn muốn cập nhật trạng thái này?')) {
                showLoading();

                $.ajax({
                    url: '@Url.Action("UpdateStatus")',
                    type: 'POST',
                    data: {
                        bookingId: bookingId,
                        status: status,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(result) {
                        hideLoading();
                        showNotification('Cập nhật trạng thái thành công!', 'success');
                        setTimeout(function() {
                            location.reload();
                        }, 1500);
                    },
                    error: function(xhr, status, error) {
                        hideLoading();
                        console.error('Error:', error);
                        showNotification('Có lỗi xảy ra khi cập nhật trạng thái!', 'error');
                    }
                });
            }
        }

        function cancelBooking(bookingId) {
            if (confirm('Bạn có chắc chắn muốn hủy booking này?')) {
                showLoading();

                $.ajax({
                    url: '@Url.Action("Cancel")',
                    type: 'POST',
                    data: {
                        bookingId: bookingId,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(result) {
                        hideLoading();
                        showNotification('Hủy booking thành công!', 'success');
                        setTimeout(function() {
                            location.reload();
                        }, 1500);
                    },
                    error: function(xhr, status, error) {
                        hideLoading();
                        console.error('Error:', error);
                        showNotification('Có lỗi xảy ra khi hủy booking!', 'error');
                    }
                });
            }
        }

        function filterByStatus(status) {
            if (status === 'all') {
                window.location.href = '@Url.Action("Index")';
            } else {
                window.location.href = '@Url.Action("Index")?status=' + status;
            }
        }

        // Bulk Actions
        function toggleSelectAll() {
            var isChecked = $('#selectAll').is(':checked');
            $('.booking-checkbox').prop('checked', isChecked);
            toggleBulkActionsPanel();
        }

        function toggleBulkActionsPanel() {
            var checkedCount = $('.booking-checkbox:checked').length;
            if (checkedCount > 0) {
                $('#bulkActionsPanel').show();
            } else {
                $('#bulkActionsPanel').hide();
            }
        }

        function bulkUpdateStatus(status) {
            var selectedIds = [];
            $('.booking-checkbox:checked').each(function() {
                selectedIds.push($(this).val());
            });

            if (selectedIds.length === 0) {
                showNotification('Vui lòng chọn ít nhất một booking!', 'warning');
                return;
            }

            if (confirm(`Bạn có chắc chắn muốn cập nhật ${selectedIds.length} booking thành trạng thái ${status}?`)) {
                showLoading();

                $.ajax({
                    url: '@Url.Action("BulkUpdateStatus")',
                    type: 'POST',
                    data: {
                        bookingIds: selectedIds,
                        status: status,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(result) {
                        hideLoading();
                        showNotification('Cập nhật hàng loạt thành công!', 'success');
                        setTimeout(function() {
                            location.reload();
                        }, 1500);
                    },
                    error: function(xhr, status, error) {
                        hideLoading();
                        console.error('Error:', error);
                        showNotification('Có lỗi xảy ra khi cập nhật hàng loạt!', 'error');
                    }
                });
            }
        }

        // Event listeners
        $(document).on('change', '.booking-checkbox', function() {
            toggleBulkActionsPanel();
        });

        $('#refreshData').click(function(e) {
            e.preventDefault();
            location.reload();
        });

        // Utility functions
        function showLoading() {
            if ($('#loadingModal').length === 0) {
                $('body').append(`
                    <div id="loadingModal" class="modal fade" tabindex="-1" role="dialog">
                        <div class="modal-dialog modal-sm" role="document">
                            <div class="modal-content">
                                <div class="modal-body text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="sr-only">Loading...</span>
                                    </div>
                                    <p class="mt-2">Đang xử lý...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `);
            }
            $('#loadingModal').modal('show');
        }

        function hideLoading() {
            $('#loadingModal').modal('hide');
        }

        function showNotification(message, type) {
            // Sử dụng toastr nếu có, nếu không thì dùng alert
            if (typeof toastr !== 'undefined') {
                toastr[type](message);
            } else {
                alert(message);
            }
        }

        function bulkActions() {
            showNotification('Vui lòng chọn các booking bằng checkbox để thực hiện thao tác hàng loạt', 'info');
        }
    </script>
}

<!-- Anti-forgery token -->
@Html.AntiForgeryToken()
