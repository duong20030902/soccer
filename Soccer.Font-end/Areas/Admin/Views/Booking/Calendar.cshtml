@using Soccer.Font_end.Areas.ViewModels
@model List<BookingDto>
@{
    ViewData["Title"] = "Lịch Booking";
}

<div class="section-body mt-3">
    <div class="container-fluid">
        <!-- Header -->
        <div class="row clearfix">
            <div class="col-lg-12">
                <div class="mb-4 d-flex justify-content-between align-items-center">
                    <div>
                        <h4>Lịch Booking Sân Bóng</h4>
                        <small>Xem booking theo dạng lịch</small>
                    </div>
                    <div>
                        <a href="@Url.Action("Index")" class="btn btn-secondary">
                            <i class="fa fa-list"></i> Xem dạng bảng
                        </a>
                        <button class="btn btn-primary" onclick="goToToday()">
                            <i class="fa fa-calendar"></i> Hôm nay
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar Navigation -->
        <div class="row clearfix">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center w-100">
                            <button class="btn btn-outline-primary" onclick="previousMonth()">
                                <i class="fa fa-chevron-left"></i> Tháng trước
                            </button>
                            <h3 class="card-title mb-0" id="currentMonth">Tháng 5, 2025</h3>
                            <button class="btn btn-outline-primary" onclick="nextMonth()">
                                Tháng sau <i class="fa fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <!-- Calendar Grid -->
                        <div class="table-responsive">
                            <table class="table table-bordered mb-0" id="calendarTable">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="text-center">Chủ Nhật</th>
                                        <th class="text-center">Thứ Hai</th>
                                        <th class="text-center">Thứ Ba</th>
                                        <th class="text-center">Thứ Tư</th>
                                        <th class="text-center">Thứ Năm</th>
                                        <th class="text-center">Thứ Sáu</th>
                                        <th class="text-center">Thứ Bảy</th>
                                    </tr>
                                </thead>
                                <tbody id="calendarBody">
                                    <!-- Calendar days will be generated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Legend -->
        <div class="row clearfix">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Chú Thích</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <span class="badge badge-success mr-2">■</span> Đã xác nhận
                            </div>
                            <div class="col-md-3">
                                <span class="badge badge-warning mr-2">■</span> Chờ xử lý
                            </div>
                            <div class="col-md-3">
                                <span class="badge badge-info mr-2">■</span> Hoàn thành
                            </div>
                            <div class="col-md-3">
                                <span class="badge badge-danger mr-2">■</span> Đã hủy
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Booking Detail Modal -->
<div class="modal fade" id="bookingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chi Tiết Booking</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">x</button>
            </div>
            <div class="modal-body" id="bookingModalBody">
                <!-- Booking details will be loaded here -->
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentDate = new Date();
        let bookings = @Html.Raw(Json.Serialize(Model));

        function generateCalendar(year, month) {
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            const calendarBody = document.getElementById('calendarBody');
            calendarBody.innerHTML = '';

            let currentWeek = document.createElement('tr');

            for (let i = 0; i < 42; i++) {
                if (i % 7 === 0 && i > 0) {
                    calendarBody.appendChild(currentWeek);
                    currentWeek = document.createElement('tr');
                }

                const cellDate = new Date(startDate);
                cellDate.setDate(startDate.getDate() + i);

                const cell = document.createElement('td');
                cell.className = 'calendar-cell';
                cell.style.height = '120px';
                cell.style.verticalAlign = 'top';
                cell.style.padding = '5px';

                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = cellDate.getDate();

                if (cellDate.getMonth() !== month) {
                    dayNumber.style.color = '#ccc';
                }

                if (cellDate.toDateString() === new Date().toDateString()) {
                    dayNumber.style.backgroundColor = '#007bff';
                    dayNumber.style.color = 'white';
                    dayNumber.style.borderRadius = '50%';
                    dayNumber.style.width = '25px';
                    dayNumber.style.height = '25px';
                    dayNumber.style.display = 'flex';
                    dayNumber.style.alignItems = 'center';
                    dayNumber.style.justifyContent = 'center';
                }

                cell.appendChild(dayNumber);

                // Add bookings for this date
                const dayBookings = bookings.filter(b => {
                    const bookingDate = new Date(b.date);
                    return bookingDate.toDateString() === cellDate.toDateString();
                });

                dayBookings.forEach(booking => {
                    const bookingElement = document.createElement('div');
                    bookingElement.className = `booking-item badge badge-${getStatusClass(booking.status)} mb-1`;
                    bookingElement.style.fontSize = '10px';
                    bookingElement.style.cursor = 'pointer';
                    bookingElement.textContent = `${booking.startTime} - ${booking.fieldName}`;
                    bookingElement.onclick = () => showBookingDetail(booking.bookingId);
                    cell.appendChild(bookingElement);
                });

                currentWeek.appendChild(cell);
            }

            if (currentWeek.children.length > 0) {
                calendarBody.appendChild(currentWeek);
            }

            // Update month title
            const monthNames = ["Tháng 1", "Tháng 2", "Tháng 3", "Tháng 4", "Tháng 5", "Tháng 6",
                "Tháng 7", "Tháng 8", "Tháng 9", "Tháng 10", "Tháng 11", "Tháng 12"];
            document.getElementById('currentMonth').textContent = `${monthNames[month]}, ${year}`;
        }

        function getStatusClass(status) {
            switch (status) {
                case 'Confirmed': return 'success';
                case 'Pending': return 'warning';
                case 'Cancelled': return 'danger';
                case 'Completed': return 'info';
                default: return 'secondary';
            }
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
        }

        function goToToday() {
            currentDate = new Date();
            generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
        }

        function showBookingDetail(bookingId) {
            // Load booking detail via AJAX
            $.get('@Url.Action("GetBookingJson")', { id: bookingId }, function(booking) {
                const modalBody = document.getElementById('bookingModalBody');
                modalBody.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Mã Booking:</strong> #${booking.bookingId}</p>
                            <p><strong>Sân:</strong> ${booking.fieldName}</p>
                            <p><strong>Khách hàng:</strong> ${booking.userName}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Ngày:</strong> ${new Date(booking.date).toLocaleDateString('vi-VN')}</p>
                            <p><strong>Giờ:</strong> ${booking.startTime} - ${booking.endTime}</p>
                            <p><strong>Giá:</strong> ${booking.price.toLocaleString('vi-VN')} VNĐ</p>
                        </div>
                    </div>
                    <div class="text-center mt-3">
                        <a href="/Admin/Booking/Details/${booking.bookingId}" class="btn btn-primary">Xem chi tiết</a>
                    </div>
                `;
                $('#bookingModal').modal('show');
            });
        }

        // Initialize calendar
        $(document).ready(function() {
            generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
        });
    </script>

    <style>
        .calendar-cell {
            position: relative;
            min-height: 120px;
        }

        .day-number {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .booking-item {
            display: block;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
}
